<script>
let clientes = JSON.parse(localStorage.getItem("clientes")) || [
  { nome: "Karla Brie", numero: "5511968971239" }
];
let historico = JSON.parse(localStorage.getItem("historico")) || [];
let ultimoValor = null;

const clienteSelect = document.getElementById("clienteSelect");
const nomeCliente = document.getElementById("nomeCliente");
const numeroCliente = document.getElementById("numeroCliente");
const resultado = document.getElementById("resultado");
const aviso = document.getElementById("aviso");
const relatorio = document.getElementById("relatorio");

function salvarLocal() {
  localStorage.setItem("clientes", JSON.stringify(clientes));
  localStorage.setItem("historico", JSON.stringify(historico));
}

function atualizarClientes() {
  clienteSelect.innerHTML = "";
  clientes.forEach((c, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = c.nome;
    clienteSelect.appendChild(opt);
  });
}

atualizarClientes();

function salvarCliente() {
  if (!nomeCliente.value || !numeroCliente.value) {
    alert("Preencha nome e WhatsApp");
    return;
  }

  clientes.push({
    nome: nomeCliente.value,
    numero: numeroCliente.value
  });

  salvarLocal();
  atualizarClientes();

  nomeCliente.value = "";
  numeroCliente.value = "";

  alert("Cliente salvo com sucesso!");
}

function excluirCliente() {
  if (clientes.length === 0) return;
  if (!confirm("Deseja excluir este cliente?")) return;

  clientes.splice(clienteSelect.value, 1);
  salvarLocal();
  atualizarClientes();
}

function calcular() {
  const kmInput = document.getElementById("km");
  const km = parseFloat(kmInput.value);

  if (isNaN(km) || km <= 0) {
    alert("Informe um KM v√°lido");
    return;
  }

  let valor = Math.ceil(km * 1.9 * 100) / 100;
  if (valor < 5) {
    valor = 5;
    aviso.textContent = "‚ö†Ô∏è Taxa m√≠nima aplicada (R$ 5,00)";
    aviso.style.color = "#fbc02d";
  } else {
    aviso.textContent = "";
  }

  ultimoValor = valor;
  resultado.innerHTML = `üí∞ R$ ${valor.toFixed(2).replace(".", ",")}`;

  historico.unshift({
    km,
    valor,
    data: new Date().toISOString()
  });

  salvarLocal();
  renderizarRelatorio();
}

function enviarWhats() {
  if (!ultimoValor) {
    alert("Calcule o frete primeiro");
    return;
  }

  const cliente = clientes[clienteSelect.value];
  const km = document.getElementById("km").value;

  const msg =
`üèçÔ∏è *Alencar Fretes*
üë§ ${cliente.nome}
üìç Dist√¢ncia: ${km} km
üí∞ Valor: R$ ${ultimoValor.toFixed(2).replace(".", ",")}

‚ùì Qual ser√° o dia e hor√°rio da entrega?`;

  window.open(
    `https://wa.me/${cliente.numero}?text=${encodeURIComponent(msg)}`,
    "_blank"
  );
}

function renderizarRelatorio() {
  relatorio.innerHTML = "";

  if (historico.length === 0) {
    relatorio.innerHTML = "<small>Nenhuma entrega registrada.</small>";
    return;
  }

  historico.forEach(h => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      üìÖ ${new Date(h.data).toLocaleDateString("pt-BR")}
      <br>üìç ${h.km} km
      <br>üí∞ R$ ${h.valor.toFixed(2).replace(".", ",")}
    `;
    relatorio.appendChild(div);
  });
}

renderizarRelatorio();
</script>
